{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://proptraderai.com/schemas/parsedRules.schema.json",
  "title": "PropTraderAI Strategy Parsed Rules",
  "description": "Complete schema for parsed trading strategy rules from natural language extraction",
  "type": "object",
  "required": ["instrument", "entry_conditions", "exit_conditions", "position_sizing"],
  "properties": {
    "instrument": {
      "type": "string",
      "enum": ["ES", "NQ", "MES", "MNQ", "YM", "RTY", "CL", "GC"],
      "description": "Futures contract symbol"
    },
    "instrument_full_name": {
      "type": "string",
      "description": "Full name of the contract (e.g., 'E-mini S&P 500')"
    },
    "entry_conditions": {
      "type": "array",
      "description": "Array of entry conditions (can have multiple for confirmation)",
      "items": {
        "$ref": "#/definitions/EntryCondition"
      },
      "minItems": 1
    },
    "exit_conditions": {
      "$ref": "#/definitions/ExitConditions",
      "description": "Complete exit strategy including stops, targets, and EOD handling"
    },
    "position_sizing": {
      "$ref": "#/definitions/PositionSizing",
      "description": "Position sizing rules and risk parameters"
    },
    "time_filters": {
      "$ref": "#/definitions/TimeFilters",
      "description": "When the strategy is active (optional)"
    },
    "prop_firm_context": {
      "$ref": "#/definitions/PropFirmContext",
      "description": "Prop firm rules and validation context (optional)"
    },
    "validation": {
      "$ref": "#/definitions/ValidationResults",
      "description": "Validation results against prop firm rules (optional)"
    }
  },
  "definitions": {
    "EntryCondition": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["indicator", "price_action", "breakout", "structure", "volume"],
          "description": "Type of entry condition"
        },
        "indicator": {
          "type": "string",
          "enum": ["EMA", "SMA", "RSI", "MACD", "VWAP", "ATR", "Bollinger_Bands", "Stochastic"],
          "description": "Indicator name (required if type='indicator')"
        },
        "period": {
          "type": "integer",
          "minimum": 1,
          "maximum": 200,
          "description": "Indicator period (e.g., 20 for 20-EMA)"
        },
        "relation": {
          "type": "string",
          "enum": [
            "price_cross_above",
            "price_cross_below",
            "price_above",
            "price_below",
            "cross_above_signal",
            "cross_below_signal",
            "above_threshold",
            "below_threshold",
            "divergence"
          ],
          "description": "Relationship that triggers entry"
        },
        "threshold": {
          "type": "number",
          "description": "Numeric threshold (e.g., RSI 70, RSI 30)"
        },
        "timeframe": {
          "type": "string",
          "enum": ["1m", "5m", "15m", "30m", "1h", "4h", "1d"],
          "description": "Chart timeframe for this condition"
        },
        "confirmation": {
          "type": "object",
          "description": "Additional confirmation requirement",
          "properties": {
            "type": {
              "type": "string",
              "enum": ["volume", "timeframe", "indicator", "candle_close"]
            },
            "threshold": {
              "type": "string",
              "description": "e.g., 'above_average', 'high', '1.5x'"
            }
          }
        },
        "pattern": {
          "type": "string",
          "enum": ["pin_bar", "engulfing", "inside_bar", "outside_bar", "doji", "hammer", "shooting_star"],
          "description": "Price action pattern (if type='price_action')"
        },
        "level": {
          "type": "string",
          "description": "Breakout level description (if type='breakout' or 'structure')"
        }
      }
    },
    "ExitConditions": {
      "type": "object",
      "required": ["stop_loss"],
      "properties": {
        "stop_loss": {
          "type": "object",
          "required": ["type", "value", "unit"],
          "properties": {
            "type": {
              "type": "string",
              "enum": ["fixed", "structure", "atr", "percentage"],
              "description": "Stop loss type"
            },
            "value": {
              "type": "number",
              "description": "Stop distance value (ticks, ATR multiple, percentage)"
            },
            "unit": {
              "type": "string",
              "enum": ["ticks", "points", "atr", "percent", "dollars"],
              "description": "Unit of measurement"
            },
            "adjustment": {
              "type": ["string", "null"],
              "enum": ["trailing", "breakeven", "none", null],
              "description": "Stop adjustment strategy"
            },
            "trailing_trigger": {
              "type": "number",
              "description": "When to start trailing (e.g., 1R profit)"
            },
            "risk_per_contract_usd": {
              "type": "number",
              "description": "Calculated USD risk per contract"
            },
            "reference": {
              "type": "string",
              "description": "Structure reference (e.g., 'swing_low', 'pin_bar_low')"
            }
          }
        },
        "profit_target": {
          "type": "object",
          "properties": {
            "type": {
              "type": "string",
              "enum": ["fixed", "risk_multiple", "structure", "none"],
              "description": "Profit target type"
            },
            "ratio": {
              "type": "number",
              "description": "R-multiple (if type='risk_multiple')"
            },
            "value_ticks": {
              "type": "number",
              "description": "Target in ticks"
            },
            "profit_per_contract_usd": {
              "type": "number",
              "description": "Calculated USD profit per contract"
            },
            "reference": {
              "type": "string",
              "description": "Structure reference (e.g., 'prior_high', 'resistance')"
            }
          }
        },
        "eod_handling": {
          "type": "string",
          "enum": ["close_all_positions", "hold_overnight", "conditional"],
          "description": "What to do at market close"
        },
        "contingency_exits": {
          "type": "array",
          "description": "Other reasons to exit before stop/target",
          "items": {
            "type": "object",
            "properties": {
              "trigger": {
                "type": "string",
                "description": "What triggers this exit"
              },
              "action": {
                "type": "string",
                "enum": ["close_full", "close_partial", "move_stop"]
              }
            }
          }
        },
        "partial_exits": {
          "type": "array",
          "description": "Scaling out rules (Phase 1B+)",
          "items": {
            "type": "object",
            "properties": {
              "contracts_to_exit": {
                "type": "integer",
                "minimum": 1
              },
              "at_level": {
                "type": "string",
                "description": "Exit level (e.g., '1R', '20 ticks', 'resistance')"
              }
            }
          }
        }
      }
    },
    "PositionSizing": {
      "type": "object",
      "required": ["method", "contracts"],
      "properties": {
        "method": {
          "type": "string",
          "enum": ["fixed", "risk_percent", "account_based", "volatility_based"],
          "description": "Position sizing method"
        },
        "risk_per_trade_percent": {
          "type": "number",
          "minimum": 0.1,
          "maximum": 10,
          "description": "Percentage of account to risk (if method='risk_percent')"
        },
        "risk_per_trade_usd": {
          "type": "number",
          "description": "Calculated dollar risk per trade"
        },
        "contracts": {
          "type": "integer",
          "minimum": 1,
          "description": "Number of contracts to trade"
        },
        "max_contracts": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum contracts allowed"
        },
        "account_size": {
          "type": "number",
          "description": "Account size used for calculations"
        }
      }
    },
    "TimeFilters": {
      "type": "object",
      "properties": {
        "trading_hours": {
          "type": "object",
          "required": ["start", "end", "timezone"],
          "properties": {
            "start": {
              "type": "string",
              "pattern": "^([0-1][0-9]|2[0-3]):[0-5][0-9]$",
              "description": "Start time in HH:MM format (24-hour)"
            },
            "end": {
              "type": "string",
              "pattern": "^([0-1][0-9]|2[0-3]):[0-5][0-9]$",
              "description": "End time in HH:MM format (24-hour)"
            },
            "timezone": {
              "type": "string",
              "description": "IANA timezone (e.g., 'America/Chicago' for CME)"
            },
            "user_specified": {
              "type": "string",
              "description": "Original user input for reference"
            }
          }
        },
        "trading_days": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["mon", "tue", "wed", "thu", "fri", "sat", "sun"]
          },
          "description": "Days of week to trade"
        },
        "avoid_news": {
          "type": "boolean",
          "description": "Whether to avoid major news releases"
        },
        "session": {
          "type": "string",
          "enum": ["RTH", "ETH", "full"],
          "description": "Trading session (Regular Trading Hours, Extended, or Full)"
        }
      }
    },
    "PropFirmContext": {
      "type": "object",
      "properties": {
        "firm_name": {
          "type": "string",
          "description": "Name of prop firm"
        },
        "firm_slug": {
          "type": "string",
          "description": "URL-safe firm identifier"
        },
        "account_size": {
          "type": "number",
          "description": "Account balance"
        },
        "daily_loss_limit": {
          "type": "number",
          "description": "Maximum daily loss allowed (USD)"
        },
        "max_drawdown": {
          "type": "number",
          "description": "Maximum drawdown allowed (USD)"
        },
        "drawdown_type": {
          "type": "string",
          "enum": ["static", "trailing", "eod_trailing"],
          "description": "Type of drawdown calculation"
        },
        "profit_target": {
          "type": "number",
          "description": "Profit target to pass challenge (USD)"
        },
        "max_contracts_allowed": {
          "type": "number",
          "description": "Maximum contracts for this instrument"
        },
        "consistency_rule": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Maximum percentage of total profit in one day (e.g., 0.5 = 50%)"
        },
        "allows_overnight": {
          "type": "boolean",
          "description": "Whether firm allows holding overnight"
        },
        "allows_news_trading": {
          "type": "boolean",
          "description": "Whether firm allows trading through news"
        },
        "automation_policy": {
          "type": "string",
          "enum": ["allowed", "prohibited", "semi_allowed", "unclear"],
          "description": "Firm's automation policy"
        }
      }
    },
    "ValidationResults": {
      "type": "object",
      "properties": {
        "risk_per_trade_vs_daily_limit": {
          "type": "number",
          "description": "Percentage of daily limit used per trade (e.g., 0.25 = 25%)"
        },
        "contracts_vs_firm_limit": {
          "type": "number",
          "description": "Percentage of firm's contract limit used (e.g., 0.5 = 50%)"
        },
        "warnings": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Non-critical warnings"
        },
        "errors": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Rule violations that must be fixed"
        },
        "is_valid": {
          "type": "boolean",
          "description": "Overall validation status"
        }
      }
    }
  }
}
